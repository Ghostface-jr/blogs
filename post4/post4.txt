<p style="margin-bottom: 0in;">Gen_Server Redux</p>
<p style="margin-bottom: 0in;">Today we will be writing anther basic database but our focus will be on learning the build process and how to use rebar. We will also monitor the database with a supervisor and eventually encapsulate it into an application.</p>
<p style="margin-bottom: 0in;">The first thing I want to introduce is rebar. <a href="https://github.com/basho/rebar/">Rebar</a> is a build tool developed by Basho Technologies for creating Erlang/OTP projects. To quote the readme "rebar uses standard Erlang/OTP conventions for project structures, thus minimizing the amount of build configuration work. rebar also provides dependency management, enabling application writers to easily re-use common libraries from a variety of locations"</p>
<p style="margin-bottom: 0in;">It's simple to use and immensely helpful. We will only scratch the surface but I implore you to explore the project..</p>
<p style="margin-bottom: 0in;">First let's create and enter a directory:&nbsp;</p>
<!-- HTML generated using hilite.me -->
<div style="background: white; overflow: auto; width: auto; color: black; border: solid gray; border-width: .1em .1em .1em .8em; padding: .2em .6em;">
<pre style="margin: 0; line-height: 125%;"><span style="color: #4e9a06;">$ </span><span style="color: #000000;">mkdir</span><span style="line-height: 125%;"> </span><span style="color: #000000;">my_db</span><span style="color: #000000; font-weight: bold;">;</span><span style="line-height: 125%;"> </span><span style="color: #000000;">cd</span><span style="line-height: 125%;"> </span><span style="color: #000000;">my_db</span></pre>
</div>
<p>Download the rebar binary:</p>
<!-- HTML generated using hilite.me -->
<div style="background: white; overflow: auto; width: auto; color: black; border: solid gray; border-width: .1em .1em .1em .8em; padding: .2em .6em;">
<pre style="margin: 0; line-height: 125%;"><span style="color: #4e9a06;">$ </span><span style="color: #000000;">wget</span> <span style="color: #000000;">https</span><span style="color: #000000; font-weight: bold;">:</span><span style="color: #ce5c00; font-weight: bold;">//</span><span style="color: #000000;">raw</span><span style="color: #000000; font-weight: bold;">.</span><span style="color: #000000;">github</span><span style="color: #000000; font-weight: bold;">.</span><span style="color: #000000;">com</span><span style="color: #ce5c00; font-weight: bold;">/</span><span style="color: #000000;">wiki</span><span style="color: #ce5c00; font-weight: bold;">/</span><span style="color: #000000;">rebar</span><span style="color: #ce5c00; font-weight: bold;">/</span><span style="color: #000000;">rebar</span><span style="color: #ce5c00; font-weight: bold;">/</span><span style="color: #000000;">rebar</span> <span style="color: #a40000;">&amp;&amp;</span> <span style="color: #000000;">chmod</span> <span style="color: #000000;">u</span><span style="color: #ce5c00; font-weight: bold;">+</span><span style="color: #000000;">x</span> <span style="color: #000000;">rebar</span>
</pre>
</div>
<p>Use rebar's templating system to create a skeleton:</p>
<!-- HTML generated using hilite.me -->
<div style="background: white; overflow: auto; width: auto; color: black; border: solid gray; border-width: .1em .1em .1em .8em; padding: .2em .6em;">
<pre style="margin: 0; line-height: 125%;"><span style="color: #4e9a06;">$ </span><span style="color: #000000; font-weight: bold;">.</span><span style="color: #ce5c00; font-weight: bold;">/</span><span style="color: #000000;">rebar</span> <span style="color: #000000;">create</span><span style="color: #ce5c00; font-weight: bold;">-</span><span style="color: #000000;">app</span> <span style="color: #000000;">appid</span><span style="color: #ce5c00; font-weight: bold;">=</span><span style="color: #000000;">my_db</span>
<span style="color: #ce5c00; font-weight: bold;">==&gt;</span> <span style="color: #000000;">my_db</span> <span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">create</span><span style="color: #ce5c00; font-weight: bold;">-</span><span style="color: #000000;">app</span><span style="color: #000000; font-weight: bold;">)</span>
<span style="color: #000000;">Writing</span> <span style="color: #000000;">src</span><span style="color: #ce5c00; font-weight: bold;">/</span><span style="color: #000000;">my_db</span><span style="color: #000000; font-weight: bold;">.</span><span style="color: #000000;">app</span><span style="color: #000000; font-weight: bold;">.</span><span style="color: #000000;">src</span>
<span style="color: #000000;">Writing</span> <span style="color: #000000;">src</span><span style="color: #ce5c00; font-weight: bold;">/</span><span style="color: #000000;">my_db_app</span><span style="color: #000000; font-weight: bold;">.</span><span style="color: #000000;">erl</span>
<span style="color: #000000;">Writing</span> <span style="color: #000000;">src</span><span style="color: #ce5c00; font-weight: bold;">/</span><span style="color: #000000;">my_db_sup</span><span style="color: #000000; font-weight: bold;">.</span><span style="color: #000000;">erl</span>
<span style="color: #4e9a06;">$ </span><span style="color: #000000;">ls</span>
<span style="color: #000000;">rebar</span>  <span style="color: #000000;">src</span></pre>
</div>
<p style="margin-bottom: 0in;">Rebar created a few files for us and put them into the src folder.</p>
<p style="margin-bottom: 0in;">The new files are:</p>
<p style="margin-bottom: 0in;">&nbsp;my_db_app.erl - the OP application specification &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;my_db_sup.erl - An implementation of the OTP Application behavior &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;my_db.app.src - An implementation of an OTP Supervisor behavior</p>
<p style="margin-bottom: 0in;">While we are at it we need to create a my_db_gen.erl file for our server code:</p>
<!-- HTML generated using hilite.me -->
<div style="background: white; overflow: auto; width: auto; color: black; border: solid gray; border-width: .1em .1em .1em .8em; padding: .2em .6em;">
<pre style="margin: 0; line-height: 125%;"><span style="color: #4e9a06;">$ </span><span style="color: #000000; font-weight: bold;">.</span><span style="color: #ce5c00; font-weight: bold;">/</span><span style="color: #000000;">rebar</span> <span style="color: #000000;">create</span> <span style="color: #000000;">template</span><span style="color: #ce5c00; font-weight: bold;">=</span><span style="color: #000000;">simplesrv</span> <span style="color: #000000;">srvid</span><span style="color: #ce5c00; font-weight: bold;">=</span><span style="color: #000000;">my_db_gen</span>
<span style="color: #ce5c00; font-weight: bold;">==&gt;</span> <span style="color: #000000;">my_db</span> <span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">create</span><span style="color: #000000; font-weight: bold;">)</span>
<span style="color: #000000;">Writing</span> <span style="color: #000000;">src</span><span style="color: #ce5c00; font-weight: bold;">/</span><span style="color: #000000;">my_db_gen</span><span style="color: #000000; font-weight: bold;">.</span><span style="color: #000000;">erl</span>
</pre>
</div>
<p>Before we move on &nbsp;we compile:</p>
<!-- HTML generated using hilite.me -->
<div style="background: white; overflow: auto; width: auto; color: black; border: solid gray; border-width: .1em .1em .1em .8em; padding: .2em .6em;">
<pre style="margin: 0; line-height: 125%;"><span style="color: #4e9a06;">$ </span><span style="color: #000000; font-weight: bold;">.</span><span style="color: #ce5c00; font-weight: bold;">/</span><span style="color: #000000;">rebar</span> <span style="color: #000000;">compile</span>
<span style="color: #ce5c00; font-weight: bold;">==&gt;</span> <span style="color: #000000;">my_db</span> <span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">compile</span><span style="color: #000000; font-weight: bold;">)</span>
<span style="color: #000000;">Compiled</span> <span style="color: #000000;">src</span><span style="color: #ce5c00; font-weight: bold;">/</span><span style="color: #000000;">my_db_sup</span><span style="color: #000000; font-weight: bold;">.</span><span style="color: #000000;">erl</span>
<span style="color: #000000;">Compiled</span> <span style="color: #000000;">src</span><span style="color: #ce5c00; font-weight: bold;">/</span><span style="color: #000000;">my_db_app</span><span style="color: #000000; font-weight: bold;">.</span><span style="color: #000000;">erl</span>
<span style="color: #000000;">Compiled</span> <span style="color: #000000;">src</span><span style="color: #ce5c00; font-weight: bold;">/</span><span style="color: #000000;">my_db_gen</span><span style="color: #000000; font-weight: bold;">.</span><span style="color: #000000;">erl</span></pre>
</div>
<p style="margin-bottom: 0in;">We haven't written any code yet but we can still see that rebar compiles our files and places them in a new ebin/ directory.</p>
<p style="margin-bottom: 0in;">A standard project directory looks something like this:</p>
<p style="margin-bottom: 0in;">&nbsp; doc/ - for documentation which typically is generated automatically &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;ebin/ - your compiled code (.beam) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;priv/ - resource files such as html, images etc. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;include/ - public header files that client code may use (.hrl) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;src/ - source code and private header files (.erl, .hrl) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;test/ - tests (_test.erl)&nbsp;</p>
<p style="margin-bottom: 0in;">First we open my_db_app. As we can see the great thing about rebar is that it generates a lot of the boilerplate code needed for modules. This file will also act as our API so we add the calling functions and make sure we launch the supervisor from the start/2 function:</p>
<p style="margin-bottom: 0in;">&nbsp;</p>
<!-- HTML generated using hilite.me -->
<div style="background: white; overflow: auto; width: auto; color: black; border: solid gray; border-width: .1em .1em .1em .8em; padding: .2em .6em;">
<pre style="margin: 0; line-height: 125%;"><span style="color: #000000; font-weight: bold;">-</span><span style="color: #ce5c00;">module</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">my_db_app</span><span style="color: #000000; font-weight: bold;">).</span>

<span style="color: #000000; font-weight: bold;">-</span><span style="color: #ce5c00;">behaviour</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">application</span><span style="color: #000000; font-weight: bold;">).</span>

<span style="color: #8f5902; font-style: italic;">%% Application callbacks</span>
<span style="color: #000000; font-weight: bold;">-</span><span style="color: #ce5c00;">export</span><span style="color: #000000; font-weight: bold;">([</span><span style="color: #000000;">start</span><span style="color: #ce5c00; font-weight: bold;">/</span><span style="color: #0000cf; font-weight: bold;">2</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">stop</span><span style="color: #ce5c00; font-weight: bold;">/</span><span style="color: #0000cf; font-weight: bold;">1</span><span style="color: #000000; font-weight: bold;">]).</span>

<span style="color: #8f5902; font-style: italic;">%% ============================================================</span>
<span style="color: #8f5902; font-style: italic;">%% Application callbacks</span>
<span style="color: #8f5902; font-style: italic;">%% ============================================================</span>

<span style="color: #000000;">start</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">normal</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000; font-weight: bold;">_</span><span style="color: #000000;">StartArgs</span><span style="color: #000000; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">-&gt;</span>
    <span style="color: #000000;">my_db_sup</span><span style="color: #000000; font-weight: bold;">:</span><span style="color: #000000;">start_link</span><span style="color: #000000; font-weight: bold;">().</span>

<span style="color: #000000;">stop</span><span style="color: #000000; font-weight: bold;">(_</span><span style="color: #000000;">State</span><span style="color: #000000; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">-&gt;</span>
    <span style="color: #000000;">ok</span><span style="color: #000000; font-weight: bold;">.</span>

<span style="color: #000000;">write</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">Key</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">Element</span><span style="color: #000000; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">-&gt;</span>
	<span style="color: #000000;">my_db_gen</span><span style="color: #000000; font-weight: bold;">:</span><span style="color: #000000;">write</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">Key</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">Element</span><span style="color: #000000; font-weight: bold;">).</span>

<span style="color: #000000;">delete</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">Key</span><span style="color: #000000; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">-&gt;</span>
	<span style="color: #000000;">my_db_gen</span><span style="color: #000000; font-weight: bold;">:</span><span style="color: #000000;">delete</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">Key</span><span style="color: #000000; font-weight: bold;">).</span>

<span style="color: #000000;">read</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">Key</span><span style="color: #000000; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">-&gt;</span>
	<span style="color: #000000;">my_db_gen</span><span style="color: #000000; font-weight: bold;">:</span><span style="color: #000000;">read</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">Key</span><span style="color: #000000; font-weight: bold;">).</span>

<span style="color: #000000;">match</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">Element</span><span style="color: #000000; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">-&gt;</span>
	<span style="color: #000000;">my_db_gen</span><span style="color: #000000; font-weight: bold;">:</span><span style="color: #000000;">match</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">Element</span><span style="color: #000000; font-weight: bold;">).</span>
</pre>
</div>
<p>Now we need to open our supervisor file. Again we can see that rebar wrote a lot of the necessary repetitive code, allowing up to focus on implementation. In my_db_sup.erl all we do is edit the init function to call start_link in our gen_server.</p>
<p style="margin-bottom: 0in;">&nbsp;</p>
<!-- HTML generated using hilite.me -->
<div style="background: white; overflow: auto; width: auto; color: black; border: solid gray; border-width: .1em .1em .1em .8em; padding: .2em .6em;">
<pre style="margin: 0; line-height: 125%;"><span style="color: #000000; font-weight: bold;">-</span><span style="color: #ce5c00;">module</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">my_db_sup</span><span style="color: #000000; font-weight: bold;">).</span>

<span style="color: #000000; font-weight: bold;">-</span><span style="color: #ce5c00;">behaviour</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">supervisor</span><span style="color: #000000; font-weight: bold;">).</span>

<span style="color: #8f5902; font-style: italic;">%% API</span>
<span style="color: #000000; font-weight: bold;">-</span><span style="color: #ce5c00;">export</span><span style="color: #000000; font-weight: bold;">([</span><span style="color: #000000;">start_link</span><span style="color: #ce5c00; font-weight: bold;">/</span><span style="color: #0000cf; font-weight: bold;">0</span><span style="color: #000000; font-weight: bold;">]).</span>

<span style="color: #8f5902; font-style: italic;">%% Supervisor callbacks</span>
<span style="color: #000000; font-weight: bold;">-</span><span style="color: #ce5c00;">export</span><span style="color: #000000; font-weight: bold;">([</span><span style="color: #000000;">init</span><span style="color: #ce5c00; font-weight: bold;">/</span><span style="color: #0000cf; font-weight: bold;">1</span><span style="color: #000000; font-weight: bold;">]).</span>

<span style="color: #8f5902; font-style: italic;">%% ============================================================</span>
<span style="color: #8f5902; font-style: italic;">%% API functions</span>
<span style="color: #8f5902; font-style: italic;">%% ============================================================</span>

<span style="color: #000000;">start_link</span><span style="color: #000000; font-weight: bold;">()</span> <span style="color: #ce5c00; font-weight: bold;">-&gt;</span>
    <span style="color: #000000;">supervisor</span><span style="color: #000000; font-weight: bold;">:</span><span style="color: #000000;">start_link</span><span style="color: #000000; font-weight: bold;">({</span><span style="color: #000000;">local</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #ce5c00; font-weight: bold;">?</span><span style="color: #000000;">MODULE</span><span style="color: #000000; font-weight: bold;">},</span> <span style="color: #ce5c00; font-weight: bold;">?</span><span style="color: #000000;">MODULE</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000; font-weight: bold;">[]).</span>

<span style="color: #8f5902; font-style: italic;">%% ============================================================</span>
<span style="color: #8f5902; font-style: italic;">%% Supervisor callbacks</span>
<span style="color: #8f5902; font-style: italic;">%% ============================================================</span>

<span style="color: #000000;">init</span><span style="color: #000000; font-weight: bold;">([])</span> <span style="color: #ce5c00; font-weight: bold;">-&gt;</span>
	<span style="color: #000000;">DbChild</span> <span style="color: #ce5c00; font-weight: bold;">=</span> <span style="color: #000000; font-weight: bold;">{</span><span style="color: #000000;">db_child</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000; font-weight: bold;">{</span><span style="color: #000000;">my_db_gen</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">start_link</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000; font-weight: bold;">[]},</span>
				<span style="color: #000000;">permanent</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #0000cf; font-weight: bold;">2000</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">worker</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000; font-weight: bold;">[</span><span style="color: #000000;">my_db_gen</span><span style="color: #000000; font-weight: bold;">]},</span>
    <span style="color: #000000; font-weight: bold;">{</span><span style="color: #000000;">ok</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000; font-weight: bold;">{</span> <span style="color: #000000; font-weight: bold;">{</span><span style="color: #000000;">one_for_one</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #0000cf; font-weight: bold;">5</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #0000cf; font-weight: bold;">10</span><span style="color: #000000; font-weight: bold;">},</span> <span style="color: #000000; font-weight: bold;">[</span><span style="color: #000000;">DbChild</span><span style="color: #000000; font-weight: bold;">]}}.</span>
</pre>
</div>
<p>In my_db_gen.erl we add this generic code:</p>
<!-- HTML generated using hilite.me -->
<div style="background: white; overflow: auto; width: auto; color: black; border: solid gray; border-width: .1em .1em .1em .8em; padding: .2em .6em;">
<pre style="margin: 0; line-height: 125%;"><span style="color: #000000; font-weight: bold;">-</span><span style="color: #ce5c00;">module</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">my_db_gen</span><span style="color: #000000; font-weight: bold;">).</span>
<span style="color: #000000; font-weight: bold;">-</span><span style="color: #ce5c00;">behaviour</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">gen_server</span><span style="color: #000000; font-weight: bold;">).</span>
<span style="color: #000000; font-weight: bold;">-</span><span style="color: #ce5c00;">define</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">SERVER</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #ce5c00; font-weight: bold;">?</span><span style="color: #000000;">MODULE</span><span style="color: #000000; font-weight: bold;">).</span>

<span style="color: #8f5902; font-style: italic;">%% ------------------------------------------------------------------</span>
<span style="color: #8f5902; font-style: italic;">%% API Function Exports</span>
<span style="color: #8f5902; font-style: italic;">%% ------------------------------------------------------------------</span>

<span style="color: #000000; font-weight: bold;">-</span><span style="color: #ce5c00;">export</span><span style="color: #000000; font-weight: bold;">([</span><span style="color: #000000;">start_link</span><span style="color: #ce5c00; font-weight: bold;">/</span><span style="color: #0000cf; font-weight: bold;">0</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">write</span><span style="color: #ce5c00; font-weight: bold;">/</span><span style="color: #0000cf; font-weight: bold;">2</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">delete</span><span style="color: #ce5c00; font-weight: bold;">/</span><span style="color: #0000cf; font-weight: bold;">1</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">read</span><span style="color: #ce5c00; font-weight: bold;">/</span><span style="color: #0000cf; font-weight: bold;">1</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">match</span><span style="color: #ce5c00; font-weight: bold;">/</span><span style="color: #0000cf; font-weight: bold;">1</span><span style="color: #000000; font-weight: bold;">]).</span>

<span style="color: #8f5902; font-style: italic;">%% ------------------------------------------------------------------</span>
<span style="color: #8f5902; font-style: italic;">%% gen_server Function Exports</span>
<span style="color: #8f5902; font-style: italic;">%% ------------------------------------------------------------------</span>

<span style="color: #000000; font-weight: bold;">-</span><span style="color: #ce5c00;">export</span><span style="color: #000000; font-weight: bold;">([</span><span style="color: #000000;">init</span><span style="color: #ce5c00; font-weight: bold;">/</span><span style="color: #0000cf; font-weight: bold;">1</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">handle_call</span><span style="color: #ce5c00; font-weight: bold;">/</span><span style="color: #0000cf; font-weight: bold;">3</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">handle_cast</span><span style="color: #ce5c00; font-weight: bold;">/</span><span style="color: #0000cf; font-weight: bold;">2</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">handle_info</span><span style="color: #ce5c00; font-weight: bold;">/</span><span style="color: #0000cf; font-weight: bold;">2</span><span style="color: #000000; font-weight: bold;">,</span>
         <span style="color: #000000;">terminate</span><span style="color: #ce5c00; font-weight: bold;">/</span><span style="color: #0000cf; font-weight: bold;">2</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">code_change</span><span style="color: #ce5c00; font-weight: bold;">/</span><span style="color: #0000cf; font-weight: bold;">3</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">match</span><span style="color: #ce5c00; font-weight: bold;">/</span><span style="color: #0000cf; font-weight: bold;">2</span><span style="color: #000000; font-weight: bold;">]).</span>

<span style="color: #8f5902; font-style: italic;">%% ------------------------------------------------------------------</span>
<span style="color: #8f5902; font-style: italic;">%% API Function Definitions</span>
<span style="color: #8f5902; font-style: italic;">%% ------------------------------------------------------------------</span>

<span style="color: #000000;">start_link</span><span style="color: #000000; font-weight: bold;">()</span> <span style="color: #ce5c00; font-weight: bold;">-&gt;</span>
    <span style="color: #000000;">gen_server</span><span style="color: #000000; font-weight: bold;">:</span><span style="color: #000000;">start_link</span><span style="color: #000000; font-weight: bold;">({</span><span style="color: #000000;">local</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #ce5c00; font-weight: bold;">?</span><span style="color: #000000;">MODULE</span><span style="color: #000000; font-weight: bold;">},</span> <span style="color: #ce5c00; font-weight: bold;">?</span><span style="color: #000000;">MODULE</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000; font-weight: bold;">[],</span> <span style="color: #000000; font-weight: bold;">[]).</span>

<span style="color: #000000;">write</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">Key</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">Element</span><span style="color: #000000; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">-&gt;</span>
	<span style="color: #000000;">gen_server</span><span style="color: #000000; font-weight: bold;">:</span><span style="color: #000000;">call</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #ce5c00; font-weight: bold;">?</span><span style="color: #000000;">MODULE</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000; font-weight: bold;">{</span><span style="color: #000000;">write</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">Key</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">Element</span><span style="color: #000000; font-weight: bold;">}).</span>

<span style="color: #000000;">delete</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">Key</span><span style="color: #000000; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">-&gt;</span>
	<span style="color: #000000;">gen_server</span><span style="color: #000000; font-weight: bold;">:</span><span style="color: #000000;">call</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #ce5c00; font-weight: bold;">?</span><span style="color: #000000;">MODULE</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000; font-weight: bold;">{</span><span style="color: #000000;">delete</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">Key</span><span style="color: #000000; font-weight: bold;">}).</span>

<span style="color: #000000;">read</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">Key</span><span style="color: #000000; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">-&gt;</span>
	<span style="color: #000000;">gen_server</span><span style="color: #000000; font-weight: bold;">:</span><span style="color: #000000;">cast</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #ce5c00; font-weight: bold;">?</span><span style="color: #000000;">MODULE</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000; font-weight: bold;">{</span><span style="color: #000000;">read</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">Key</span><span style="color: #000000; font-weight: bold;">}).</span>

<span style="color: #000000;">match</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">Element</span><span style="color: #000000; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">-&gt;</span>
	<span style="color: #000000;">gen_server</span><span style="color: #000000; font-weight: bold;">:</span><span style="color: #000000;">cast</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #ce5c00; font-weight: bold;">?</span><span style="color: #000000;">MODULE</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000; font-weight: bold;">{</span><span style="color: #000000;">match</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">Element</span><span style="color: #000000; font-weight: bold;">}).</span>

<span style="color: #8f5902; font-style: italic;">%% ------------------------------------------------------------------</span>
<span style="color: #8f5902; font-style: italic;">%% gen_server Function Definitions</span>
<span style="color: #8f5902; font-style: italic;">%% ------------------------------------------------------------------</span>

<span style="color: #000000;">init</span><span style="color: #000000; font-weight: bold;">([])</span> <span style="color: #ce5c00; font-weight: bold;">-&gt;</span>
    <span style="color: #000000; font-weight: bold;">{</span><span style="color: #000000;">ok</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000; font-weight: bold;">[]}.</span>

<span style="color: #000000;">handle_call</span><span style="color: #000000; font-weight: bold;">({</span><span style="color: #000000;">write</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">Key</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">Element</span><span style="color: #000000; font-weight: bold;">},</span> <span style="color: #000000; font-weight: bold;">_</span><span style="color: #000000;">From</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">State</span><span style="color: #000000; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">-&gt;</span>
	<span style="color: #000000;">NewState</span> <span style="color: #ce5c00; font-weight: bold;">=</span> <span style="color: #000000; font-weight: bold;">[{</span><span style="color: #000000;">Key</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">Element</span><span style="color: #000000; font-weight: bold;">}</span> <span style="color: #000000; font-weight: bold;">|</span> <span style="color: #000000;">State</span><span style="color: #000000; font-weight: bold;">],</span>
    <span style="color: #000000; font-weight: bold;">{</span><span style="color: #000000;">reply</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">ok</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">NewState</span><span style="color: #000000; font-weight: bold;">};</span>
<span style="color: #000000;">handle_call</span><span style="color: #000000; font-weight: bold;">({</span><span style="color: #000000;">delete</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">Key</span><span style="color: #000000; font-weight: bold;">},</span> <span style="color: #000000; font-weight: bold;">_</span><span style="color: #000000;">From</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">State</span><span style="color: #000000; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">-&gt;</span>
	<span style="color: #000000;">NewState</span> <span style="color: #ce5c00; font-weight: bold;">=</span> <span style="color: #000000;">lists</span><span style="color: #000000; font-weight: bold;">:</span><span style="color: #000000;">keydelete</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">Key</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #0000cf; font-weight: bold;">1</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">State</span><span style="color: #000000; font-weight: bold;">),</span>
	<span style="color: #000000; font-weight: bold;">{</span><span style="color: #000000;">reply</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">ok</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">NewState</span><span style="color: #000000; font-weight: bold;">};</span>
<span style="color: #000000;">handle_call</span><span style="color: #000000; font-weight: bold;">(_</span><span style="color: #000000;">Msg</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000; font-weight: bold;">_</span><span style="color: #000000;">From</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">State</span><span style="color: #000000; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">-&gt;</span>  
	<span style="color: #000000; font-weight: bold;">{</span><span style="color: #000000;">noreply</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">State</span><span style="color: #000000; font-weight: bold;">}.</span>

<span style="color: #000000;">handle_cast</span><span style="color: #000000; font-weight: bold;">({</span><span style="color: #000000;">read</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">Key</span><span style="color: #000000; font-weight: bold;">},</span> <span style="color: #000000;">State</span><span style="color: #000000; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">-&gt;</span>
	<span style="color: #000000; font-weight: bold;">{</span><span style="color: #000000;">Key</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">Element</span><span style="color: #000000; font-weight: bold;">}</span> <span style="color: #ce5c00; font-weight: bold;">=</span> <span style="color: #000000;">lists</span><span style="color: #000000; font-weight: bold;">:</span><span style="color: #000000;">keyfind</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">Key</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #0000cf; font-weight: bold;">1</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">State</span><span style="color: #000000; font-weight: bold;">),</span>
	<span style="color: #000000;">io</span><span style="color: #000000; font-weight: bold;">:</span><span style="color: #000000;">format</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #4e9a06;">"~p~n"</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000; font-weight: bold;">[{</span><span style="color: #000000;">Key</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">Element</span><span style="color: #000000; font-weight: bold;">}]),</span>
	<span style="color: #000000; font-weight: bold;">{</span><span style="color: #000000;">noreply</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">State</span><span style="color: #000000; font-weight: bold;">};</span>
<span style="color: #000000;">handle_cast</span><span style="color: #000000; font-weight: bold;">({</span><span style="color: #000000;">match</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">Element</span><span style="color: #000000; font-weight: bold;">},</span> <span style="color: #000000;">State</span><span style="color: #000000; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">-&gt;</span>
	<span style="color: #000000;">Matches</span> <span style="color: #ce5c00; font-weight: bold;">=</span> <span style="color: #000000;">match</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">Element</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">State</span><span style="color: #000000; font-weight: bold;">),</span>
	<span style="color: #000000;">io</span><span style="color: #000000; font-weight: bold;">:</span><span style="color: #000000;">format</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #4e9a06;">"found elements ~p~n"</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000; font-weight: bold;">[</span><span style="color: #000000;">Matches</span><span style="color: #000000; font-weight: bold;">]),</span>
	<span style="color: #000000; font-weight: bold;">{</span><span style="color: #000000;">noreply</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">State</span><span style="color: #000000; font-weight: bold;">};</span>
<span style="color: #000000;">handle_cast</span><span style="color: #000000; font-weight: bold;">(_</span><span style="color: #000000;">Msg</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">State</span><span style="color: #000000; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">-&gt;</span>
    <span style="color: #000000; font-weight: bold;">{</span><span style="color: #000000;">noreply</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">State</span><span style="color: #000000; font-weight: bold;">}.</span>

<span style="color: #000000;">handle_info</span><span style="color: #000000; font-weight: bold;">(_</span><span style="color: #000000;">Info</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">State</span><span style="color: #000000; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">-&gt;</span>
    <span style="color: #000000; font-weight: bold;">{</span><span style="color: #000000;">noreply</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">State</span><span style="color: #000000; font-weight: bold;">}.</span>

<span style="color: #000000;">terminate</span><span style="color: #000000; font-weight: bold;">(_</span><span style="color: #000000;">Reason</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000; font-weight: bold;">_</span><span style="color: #000000;">State</span><span style="color: #000000; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">-&gt;</span>
    <span style="color: #000000;">ok</span><span style="color: #000000; font-weight: bold;">.</span>

<span style="color: #000000;">code_change</span><span style="color: #000000; font-weight: bold;">(_</span><span style="color: #000000;">OldVsn</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">State</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000; font-weight: bold;">_</span><span style="color: #000000;">Extra</span><span style="color: #000000; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">-&gt;</span>
    <span style="color: #000000; font-weight: bold;">{</span><span style="color: #000000;">ok</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">State</span><span style="color: #000000; font-weight: bold;">}.</span>

<span style="color: #8f5902; font-style: italic;">%% ------------------------------------------------------------------</span>
<span style="color: #8f5902; font-style: italic;">%% Internal Function Definitions</span>
<span style="color: #8f5902; font-style: italic;">%% ------------------------------------------------------------------</span>

<span style="color: #000000;">match</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">Element</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">List</span><span style="color: #000000; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">-&gt;</span>
	<span style="color: #000000;">match</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">Element</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">List</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000; font-weight: bold;">[]).</span>

<span style="color: #000000;">match</span><span style="color: #000000; font-weight: bold;">(_</span><span style="color: #000000;">Element</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000; font-weight: bold;">[],</span> <span style="color: #000000;">Matches</span><span style="color: #000000; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">-&gt;</span>
	<span style="color: #000000;">Matches</span><span style="color: #000000; font-weight: bold;">;</span>
<span style="color: #000000;">match</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">Element</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000; font-weight: bold;">[{</span><span style="color: #000000;">Key</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">Element</span><span style="color: #000000; font-weight: bold;">}</span> <span style="color: #000000; font-weight: bold;">|</span> <span style="color: #000000;">T_List</span><span style="color: #000000; font-weight: bold;">],</span> <span style="color: #000000;">Matches</span><span style="color: #000000; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">-&gt;</span>
	<span style="color: #000000;">NewMatch</span> <span style="color: #ce5c00; font-weight: bold;">=</span> <span style="color: #000000; font-weight: bold;">[{</span><span style="color: #000000;">Key</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">Element</span><span style="color: #000000; font-weight: bold;">}</span> <span style="color: #000000; font-weight: bold;">|</span> <span style="color: #000000;">Matches</span><span style="color: #000000; font-weight: bold;">],</span>
	<span style="color: #000000;">match</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">Element</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">T_List</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">NewMatch</span><span style="color: #000000; font-weight: bold;">);</span>
<span style="color: #000000;">match</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">Element</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000; font-weight: bold;">[{_</span><span style="color: #000000;">Key</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000; font-weight: bold;">_</span><span style="color: #000000;">Element</span><span style="color: #000000; font-weight: bold;">}</span> <span style="color: #000000; font-weight: bold;">|</span> <span style="color: #000000;">T_List</span><span style="color: #000000; font-weight: bold;">],</span> <span style="color: #000000;">Matches</span><span style="color: #000000; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">-&gt;</span>
	<span style="color: #000000;">match</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">Element</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">T_List</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">Matches</span><span style="color: #000000; font-weight: bold;">).</span>
</pre>
</div>
<p>Testing the supervisor and gen_server from the shell we can see they work.</p>
<!-- HTML generated using hilite.me -->
<div style="background: white; overflow: auto; width: auto; color: black; border: solid gray; border-width: .1em .1em .1em .8em; padding: .2em .6em;">
<pre style="margin: 0; line-height: 125%;"><span style="color: #0000cf; font-weight: bold;">1</span><span style="color: #ce5c00; font-weight: bold;">&gt;</span> <span style="color: #000000;">my_db_sup</span><span style="color: #000000; font-weight: bold;">:</span><span style="color: #000000;">start_link</span><span style="color: #000000; font-weight: bold;">().</span>
<span style="color: #000000; font-weight: bold;">{</span><span style="color: #000000;">ok</span><span style="color: #000000; font-weight: bold;">,</span><span style="color: #ce5c00; font-weight: bold;">&lt;</span><span style="color: #0000cf; font-weight: bold;">0</span><span style="color: #000000; font-weight: bold;">.</span><span style="color: #0000cf; font-weight: bold;">34</span><span style="color: #000000; font-weight: bold;">.</span><span style="color: #0000cf; font-weight: bold;">0</span><span style="color: #ce5c00; font-weight: bold;">&gt;</span><span style="color: #000000; font-weight: bold;">}</span>
<span style="color: #0000cf; font-weight: bold;">2</span><span style="color: #ce5c00; font-weight: bold;">&gt;</span> <span style="color: #000000;">my_db_gen</span><span style="color: #000000; font-weight: bold;">:</span><span style="color: #000000;">write</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">joey</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">joey</span><span style="color: #000000; font-weight: bold;">@</span><span style="color: #000000;">gmail</span><span style="color: #000000; font-weight: bold;">).</span>
<span style="color: #000000;">ok</span>
<span style="color: #0000cf; font-weight: bold;">3</span><span style="color: #ce5c00; font-weight: bold;">&gt;</span> <span style="color: #000000;">my_db_gen</span><span style="color: #000000; font-weight: bold;">:</span><span style="color: #000000;">write</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">bob</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">bob</span><span style="color: #000000; font-weight: bold;">@</span><span style="color: #000000;">gmail</span><span style="color: #000000; font-weight: bold;">).</span>  
<span style="color: #000000;">ok</span>
<span style="color: #0000cf; font-weight: bold;">4</span><span style="color: #ce5c00; font-weight: bold;">&gt;</span> <span style="color: #000000;">my_db_gen</span><span style="color: #000000; font-weight: bold;">:</span><span style="color: #000000;">match</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">bob</span><span style="color: #000000; font-weight: bold;">@</span><span style="color: #000000;">gmail</span><span style="color: #000000; font-weight: bold;">).</span>     
<span style="color: #000000;">found</span> <span style="color: #000000;">elements</span> <span style="color: #000000; font-weight: bold;">[{</span><span style="color: #000000;">bob</span><span style="color: #000000; font-weight: bold;">,</span><span style="color: #000000;">bob</span><span style="color: #000000; font-weight: bold;">@</span><span style="color: #000000;">gmail</span><span style="color: #000000; font-weight: bold;">}]</span>
<span style="color: #000000;">ok</span>
</pre>
</div>
<p>The final step will be to encapsulate the entire database as an application. This allows us to make it a modular component that other developers can include in their program. OTP application behavior requires two files. A configuration file named appname.app and an Erlang source file called appname_app.erl. In our case, ebin/my_db.app and src/my_db_app.erl</p>
<p style="margin-bottom: 0in;">Here are what mine look like:</p>
<!-- HTML generated using hilite.me -->
<div style="background: white; overflow: auto; width: auto; color: black; border: solid gray; border-width: .1em .1em .1em .8em; padding: .2em .6em;">
<pre style="margin: 0; line-height: 125%;"><span style="color: #000000; font-weight: bold;">%% my_db_app.erl</span></pre>
<pre style="margin: 0; line-height: 125%;"><span style="color: #000000; font-weight: bold;">-</span><span style="color: #ce5c00;">module</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">my_db_app</span><span style="color: #000000; font-weight: bold;">).</span>

<span style="color: #000000; font-weight: bold;">-</span><span style="color: #ce5c00;">behaviour</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">application</span><span style="color: #000000; font-weight: bold;">).</span>

<span style="color: #8f5902; font-style: italic;">%% Application callbacks</span>
<span style="color: #000000; font-weight: bold;">-</span><span style="color: #ce5c00;">export</span><span style="color: #000000; font-weight: bold;">([</span><span style="color: #000000;">start</span><span style="color: #ce5c00; font-weight: bold;">/</span><span style="color: #0000cf; font-weight: bold;">2</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">stop</span><span style="color: #ce5c00; font-weight: bold;">/</span><span style="color: #0000cf; font-weight: bold;">1</span><span style="color: #000000; font-weight: bold;">]).</span>

<span style="color: #8f5902; font-style: italic;">%% ============================================================</span>
<span style="color: #8f5902; font-style: italic;">%% Application callbacks</span>
<span style="color: #8f5902; font-style: italic;">%% ============================================================</span>

<span style="color: #000000;">start</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">normal</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000; font-weight: bold;">_</span><span style="color: #000000;">StartArgs</span><span style="color: #000000; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">-&gt;</span>
    <span style="color: #000000;">my_db_sup</span><span style="color: #000000; font-weight: bold;">:</span><span style="color: #000000;">start_link</span><span style="color: #000000; font-weight: bold;">().</span>

<span style="color: #000000;">stop</span><span style="color: #000000; font-weight: bold;">(_</span><span style="color: #000000;">State</span><span style="color: #000000; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">-&gt;</span>
    <span style="color: #000000;">ok</span><span style="color: #000000; font-weight: bold;">.</span>
</pre>
</div>
<p style="margin-bottom: 0in;">&nbsp;</p>
<!-- HTML generated using hilite.me -->
<div style="background: white; overflow: auto; width: auto; color: black; border: solid gray; border-width: .1em .1em .1em .8em; padding: .2em .6em;">
<pre style="margin: 0; line-height: 125%;"><span style="color: #000000; font-weight: bold;">%% my_db.app</span></pre>
<pre style="margin: 0; line-height: 125%;"><span style="color: #000000; font-weight: bold;">{</span><span style="color: #000000;">application</span><span style="color: #000000; font-weight: bold;">,</span><span style="color: #000000;">my_db</span><span style="color: #000000; font-weight: bold;">,</span>
             <span style="color: #000000; font-weight: bold;">[{</span><span style="color: #000000;">description</span><span style="color: #000000; font-weight: bold;">,[]},</span>
              <span style="color: #000000; font-weight: bold;">{</span><span style="color: #000000;">vsn</span><span style="color: #000000; font-weight: bold;">,</span><span style="color: #4e9a06;">"1"</span><span style="color: #000000; font-weight: bold;">},</span>
              <span style="color: #000000; font-weight: bold;">{</span><span style="color: #000000;">registered</span><span style="color: #000000; font-weight: bold;">,[]},</span>
              <span style="color: #000000; font-weight: bold;">{</span><span style="color: #000000;">applications</span><span style="color: #000000; font-weight: bold;">,[</span><span style="color: #000000;">kernel</span><span style="color: #000000; font-weight: bold;">,</span><span style="color: #000000;">stdlib</span><span style="color: #000000; font-weight: bold;">]},</span>
              <span style="color: #000000; font-weight: bold;">{</span><span style="color: #000000;">mod</span><span style="color: #000000; font-weight: bold;">,{</span><span style="color: #000000;">my_db_app</span><span style="color: #000000; font-weight: bold;">,[]}},</span>
              <span style="color: #000000; font-weight: bold;">{</span><span style="color: #000000;">env</span><span style="color: #000000; font-weight: bold;">,[]},</span>
              <span style="color: #000000; font-weight: bold;">{</span><span style="color: #000000;">modules</span><span style="color: #000000; font-weight: bold;">,[</span><span style="color: #000000;">my_db_app</span><span style="color: #000000; font-weight: bold;">,</span><span style="color: #000000;">my_db_gen</span><span style="color: #000000; font-weight: bold;">,</span><span style="color: #000000;">my_db_sup</span><span style="color: #000000; font-weight: bold;">]}]}.</span>
</pre>
</div>
<p style="margin-bottom: 0in;">The my_db.app is a configuration file that tells Erlang how to launch our application. It is simple a tuple, the first element is the atom application, the second the application name and the third a list of key-value pairs.</p>
<p style="margin-bottom: 0in;">&nbsp; description &ndash; a short description string &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;vsn &ndash; the applications version (Major.minor.patch format) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;registered &ndash; the list of names our app registeres itself under &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;applications &ndash; list of applications our app depends on, ever app requires kernel and stdlib &nbsp; &nbsp; &nbsp;&nbsp;mod &ndash; which module contains our application behavior &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;env &ndash; environmental variables you may with to pass to your application &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;modules &ndash; is the list of modules our application consists of</p>
<p style="margin-bottom: 0in;">The only thing left to do is test it:</p>
<!-- HTML generated using hilite.me -->
<div style="background: white; overflow: auto; width: auto; color: black; border: solid gray; border-width: .1em .1em .1em .8em; padding: .2em .6em;">
<pre style="margin: 0; line-height: 125%;"><span style="color: #0000cf; font-weight: bold;">1</span><span style="color: #ce5c00; font-weight: bold;">&gt;</span> <span style="color: #000000;">application</span><span style="color: #000000; font-weight: bold;">:</span><span style="color: #000000;">start</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">my_db</span><span style="color: #000000; font-weight: bold;">).</span>
<span style="color: #000000;">ok</span>
<span style="color: #0000cf; font-weight: bold;">2</span><span style="color: #ce5c00; font-weight: bold;">&gt;</span> <span style="color: #000000;">my_db</span><span style="color: #000000; font-weight: bold;">:</span><span style="color: #000000;">write</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">joey</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">joe</span><span style="color: #000000; font-weight: bold;">).</span>
<span style="color: #000000;">ok</span>
<span style="color: #0000cf; font-weight: bold;">3</span><span style="color: #ce5c00; font-weight: bold;">&gt;</span> <span style="color: #000000;">my_db</span><span style="color: #000000; font-weight: bold;">:</span><span style="color: #000000;">write</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">joey</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">joe</span><span style="color: #000000; font-weight: bold;">).</span>
<span style="color: #000000;">ok</span>
<span style="color: #0000cf; font-weight: bold;">4</span><span style="color: #ce5c00; font-weight: bold;">&gt;</span> <span style="color: #000000;">my_db</span><span style="color: #000000; font-weight: bold;">:</span><span style="color: #000000;">read</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">joey</span><span style="color: #000000; font-weight: bold;">).</span>
<span style="color: #000000; font-weight: bold;">{</span><span style="color: #000000;">joey</span><span style="color: #000000; font-weight: bold;">,</span><span style="color: #000000;">joe</span><span style="color: #000000; font-weight: bold;">}</span>
<span style="color: #000000;">ok</span></pre>
</div>
<p>&nbsp;</p>
<p style="margin-bottom: 0in;">As we can see it works perfectly. Hopefully this lesson helped you understand some of the Erlang/OTP tools and build properties. At this point you should be able to understand the mechanics of most Erlang code. Till next time!</p>
<p>Full code at&nbsp;https://github.com/Ghostface-jr/blogs/tree/master/post4</p>
