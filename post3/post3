<p style="margin-bottom: 0in;">Today I'm going to build a basic associative store with an event manager using OTP. OTP, short for Open Telecom Platform, is one of the most important things to utilize when programming in Erlang. OTP is a battle hardened process design framework that takes care of the reusable code and allows programmers to work on the logic.</p>
<p style="margin-bottom: 0in;">In fact the standard library and the VM's kernel are OTP applications themselves, which means that Erlang is a language used to build OTP, but whose runtime environment depends on OTP to work. This shows us it's circular and gives you some idea of why the language is officially named 'Erlang/OTP'.</p>
<p style="margin-bottom: 0in;">To use the OTP framework you have to declare the behavior in your module, this loads all the generic code and lets the process "inherit" the behaviors functions. Allowing the module to do things like:</p>
<p style="margin-bottom: 0in;">&bull; Spawn and register the process</p>
<p style="margin-bottom: 0in;">&bull; Send and receive client messages as synchronous or asynchronous calls, as well as define the internal message protocol</p>
<p style="margin-bottom: 0in;">&bull; Store the loop data and manage the process loop</p>
<p style="margin-bottom: 0in;">&bull; Stop the process</p>
<p style="margin-bottom: 0in;">Since all the tedious, boring work is done for you you can focus on writing the server callbacks. This is one of the reasons Erlang programs are so robust and have relatively small lines of code compared to similar systems in say Java.</p>
<p style="margin-bottom: 0in;">Gen_server is the OTP behavior used to build client-server system.</p>
<p style="margin-bottom: 0in;"><img class="posterous_plugin_object posterous_plugin_object_image" src="http://getfile0.posterous.com/getfile/files.posterous.com/temp-2013-01-29/HBIvutflkfabaJJIFwHEEgCwrEEkExfFIrEBmegBCpdfgrfoCAqggbjlqdlj/server.xcf.thumb100.jpg?content_part=cHwlatCAkCgiiqErkodr" alt="" width="100" height="100" /></p>
<p style="margin-bottom: 0in;">In our picture we see a server interacting with it's clients by sending them synchronous calls then waiting for a reply as well as sending asynchronous messages through casts.</p>
<p style="margin-bottom: 0in;">To get a feel for gen_server we are going to build an associative data store in the form of an address book.&nbsp;</p>
<p style="margin-bottom: 0in;">Lets get started by defining the behaviour and exporting the functions we are going to use.</p>
<!-- HTML generated using hilite.me -->
<div style="background: white; overflow: auto; width: auto; color: black; border: solid gray; border-width: .1em .1em .1em .8em; padding: .2em .6em;">
<pre style="margin: 0; line-height: 125%;"><span style="color: #000000; font-weight: bold;">-</span><span style="color: #ce5c00;">module</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">assoc_store</span><span style="color: #000000; font-weight: bold;">).</span>
<span style="color: #000000; font-weight: bold;">-</span><span style="color: #ce5c00;">behaviour</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">gen_server</span><span style="color: #000000; font-weight: bold;">).</span>

<span style="color: #8f5902; font-style: italic;">% API exports</span>
<span style="color: #000000; font-weight: bold;">-</span><span style="color: #ce5c00;">export</span><span style="color: #000000; font-weight: bold;">([</span><span style="color: #000000;">start_link</span><span style="color: #ce5c00; font-weight: bold;">/</span><span style="color: #0000cf; font-weight: bold;">0</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">stop</span><span style="color: #ce5c00; font-weight: bold;">/</span><span style="color: #0000cf; font-weight: bold;">0</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">add_user</span><span style="color: #ce5c00; font-weight: bold;">/</span><span style="color: #0000cf; font-weight: bold;">2</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">remove_user</span><span style="color: #ce5c00; font-weight: bold;">/</span><span style="color: #0000cf; font-weight: bold;">1</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">find_user</span><span style="color: #ce5c00; font-weight: bold;">/</span><span style="color: #0000cf; font-weight: bold;">1</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">show_all</span><span style="color: #ce5c00; font-weight: bold;">/</span><span style="color: #0000cf; font-weight: bold;">0</span><span style="color: #000000; font-weight: bold;">]).</span>

<span style="color: #8f5902; font-style: italic;">% gen_server exports</span>
<span style="color: #000000; font-weight: bold;">-</span><span style="color: #ce5c00;">export</span><span style="color: #000000; font-weight: bold;">([</span><span style="color: #000000;">init</span><span style="color: #ce5c00; font-weight: bold;">/</span><span style="color: #0000cf; font-weight: bold;">1</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">handle_call</span><span style="color: #ce5c00; font-weight: bold;">/</span><span style="color: #0000cf; font-weight: bold;">3</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">handle_cast</span><span style="color: #ce5c00; font-weight: bold;">/</span><span style="color: #0000cf; font-weight: bold;">2</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">handle_info</span><span style="color: #ce5c00; font-weight: bold;">/</span><span style="color: #0000cf; font-weight: bold;">2</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">code_change</span><span style="color: #ce5c00; font-weight: bold;">/</span><span style="color: #0000cf; font-weight: bold;">3</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">terminate</span><span style="color: #ce5c00; font-weight: bold;">/</span><span style="color: #0000cf; font-weight: bold;">2</span><span style="color: #000000; font-weight: bold;">]).</span></pre>
</div>
<p>Our module takes on the poperties of a gen_server, we can see how easy the API functions are to define because of this.</p>
<!-- HTML generated using hilite.me -->
<div style="background: white; overflow: auto; width: auto; color: black; border: solid gray; border-width: .1em .1em .1em .8em; padding: .2em .6em;">
<pre style="margin: 0; line-height: 125%;"><span style="color: #8f5902; font-style: italic;">% API Functions</span>
<span style="color: #000000;">start_link</span><span style="color: #000000; font-weight: bold;">()</span> <span style="color: #ce5c00; font-weight: bold;">-&gt;</span>
	<span style="color: #000000;">gen_server</span><span style="color: #000000; font-weight: bold;">:</span><span style="color: #000000;">start_link</span><span style="color: #000000; font-weight: bold;">({</span><span style="color: #000000;">local</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">nodeA</span><span style="color: #000000; font-weight: bold;">},</span> ?MODULE<span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000; font-weight: bold;">[],</span> <span style="color: #000000; font-weight: bold;">[]).</span>

<span style="color: #000000;">stop</span><span style="color: #000000; font-weight: bold;">()</span> <span style="color: #ce5c00; font-weight: bold;">-&gt;</span>
	<span style="color: #000000;">gen_server</span><span style="color: #000000; font-weight: bold;">:</span><span style="color: #000000;">call</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #ce5c00; font-weight: bold;">?</span><span style="color: #000000;">MODULE</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">stop</span><span style="color: #000000; font-weight: bold;">).</span>

<span style="color: #000000;">add_user</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">Name</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">Email</span><span style="color: #000000; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">-&gt;</span>
	<span style="color: #000000;">gen_server</span><span style="color: #000000; font-weight: bold;">:</span><span style="color: #000000;">call</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">nodeA</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000; font-weight: bold;">{</span><span style="color: #000000;">add_user</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">Name</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">Email</span><span style="color: #000000; font-weight: bold;">}).</span>

<span style="color: #000000;">remove_user</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">Name</span><span style="color: #000000; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">-&gt;</span> 
	<span style="color: #000000;">gen_server</span><span style="color: #000000; font-weight: bold;">:</span><span style="color: #000000;">call</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">nodeA</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000; font-weight: bold;">{</span><span style="color: #000000;">remove_user</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">Name</span><span style="color: #000000; font-weight: bold;">}).</span>

<span style="color: #000000;">find_user</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">Name</span><span style="color: #000000; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">-&gt;</span>
	<span style="color: #000000;">gen_server</span><span style="color: #000000; font-weight: bold;">:</span><span style="color: #000000;">call</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">nodeA</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000; font-weight: bold;">{</span><span style="color: #000000;">find_user</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">Name</span><span style="color: #000000; font-weight: bold;">}).</span>

<span style="color: #000000;">show_all</span><span style="color: #000000; font-weight: bold;">()</span> <span style="color: #ce5c00; font-weight: bold;">-&gt;</span>
	<span style="color: #000000;">gen_server</span><span style="color: #000000; font-weight: bold;">:</span><span style="color: #000000;">cast</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">nodeA</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">show_all</span><span style="color: #000000; font-weight: bold;">).</span>
</pre>
</div>
<p>Start link starts the server, the first argument is a tuple of the {registered, name}, where the process can be registered locally or globally. The second is the name of the module where init is located, in this case our same module. The third argument is a list of arguments to pass to our init function.</p>
<p>The way to communicate with our server is to use the gen_server:call for synchronous messages and gen_server:cast for asynchronous messages.</p>
<!-- HTML generated using hilite.me -->
<div style="background: white; overflow: auto; width: auto; color: black; border: solid gray; border-width: .1em .1em .1em .8em; padding: .2em .6em;">
<pre style="margin: 0; line-height: 125%;"><span style="color: #8f5902; font-style: italic;">% gen_server Functions</span>
<span style="color: #000000;">init</span><span style="color: #000000; font-weight: bold;">([])</span> <span style="color: #ce5c00; font-weight: bold;">-&gt;</span>
	<span style="color: #000000; font-weight: bold;">{</span><span style="color: #000000;">ok</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000; font-weight: bold;">[]}.</span>

<span style="color: #000000;">handle_call</span><span style="color: #000000; font-weight: bold;">({</span><span style="color: #000000;">add_user</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">Name</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">Email</span><span style="color: #000000; font-weight: bold;">},</span> <span style="color: #000000; font-weight: bold;">_</span><span style="color: #000000;">From</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">State</span><span style="color: #000000; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">-&gt;</span>
	<span style="color: #000000;">NewState</span> <span style="color: #ce5c00; font-weight: bold;">=</span> <span style="color: #000000; font-weight: bold;">[{</span><span style="color: #000000;">Name</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">Email</span><span style="color: #000000; font-weight: bold;">}|</span><span style="color: #000000;">State</span><span style="color: #000000; font-weight: bold;">],</span>
	<span style="color: #000000;">io</span><span style="color: #000000; font-weight: bold;">:</span><span style="color: #000000;">format</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #4e9a06;">"~p~n"</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000; font-weight: bold;">[</span><span style="color: #000000;">NewState</span><span style="color: #000000; font-weight: bold;">]),</span>
	<span style="color: #000000; font-weight: bold;">{</span><span style="color: #000000;">reply</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">ok</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">NewState</span><span style="color: #000000; font-weight: bold;">};</span>

<span style="color: #000000;">handle_call</span><span style="color: #000000; font-weight: bold;">({</span><span style="color: #000000;">remove_user</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">Name</span><span style="color: #000000; font-weight: bold;">},</span> <span style="color: #000000; font-weight: bold;">_</span><span style="color: #000000;">From</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">State</span><span style="color: #000000; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">-&gt;</span>
	<span style="color: #000000;">User</span> <span style="color: #ce5c00; font-weight: bold;">=</span> <span style="color: #000000;">lists</span><span style="color: #000000; font-weight: bold;">:</span><span style="color: #000000;">keyfind</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">Name</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #0000cf; font-weight: bold;">1</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">State</span><span style="color: #000000; font-weight: bold;">),</span>
	<span style="color: #000000;">NewState</span> <span style="color: #ce5c00; font-weight: bold;">=</span> <span style="color: #000000;">lists</span><span style="color: #000000; font-weight: bold;">:</span><span style="color: #000000;">delete</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">User</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">State</span><span style="color: #000000; font-weight: bold;">),</span>
	<span style="color: #000000; font-weight: bold;">{</span><span style="color: #000000;">reply</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">ok</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">NewState</span><span style="color: #000000; font-weight: bold;">};</span>

<span style="color: #000000;">handle_call</span><span style="color: #000000; font-weight: bold;">({</span><span style="color: #000000;">find_user</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">Name</span><span style="color: #000000; font-weight: bold;">},</span> <span style="color: #000000; font-weight: bold;">_</span><span style="color: #000000;">From</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">State</span><span style="color: #000000; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">-&gt;</span> 
	<span style="color: #000000; font-weight: bold;">{</span><span style="color: #000000;">Nam</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">Email</span><span style="color: #000000; font-weight: bold;">}</span> <span style="color: #ce5c00; font-weight: bold;">=</span> <span style="color: #000000;">lists</span><span style="color: #000000; font-weight: bold;">:</span><span style="color: #000000;">keyfind</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">Name</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #0000cf; font-weight: bold;">1</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">State</span><span style="color: #000000; font-weight: bold;">),</span>
	<span style="color: #000000;">io</span><span style="color: #000000; font-weight: bold;">:</span><span style="color: #000000;">format</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #4e9a06;">"User: ~s's email is ~s.~n"</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000; font-weight: bold;">[</span><span style="color: #000000;">Nam</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">Email</span><span style="color: #000000; font-weight: bold;">]),</span>
	<span style="color: #000000; font-weight: bold;">{</span><span style="color: #000000;">reply</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">ok</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">State</span><span style="color: #000000; font-weight: bold;">};</span>	

<span style="color: #000000;">handle_call</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">stop</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000; font-weight: bold;">_</span><span style="color: #000000;">From</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">State</span><span style="color: #000000; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">-&gt;</span> 
    <span style="color: #000000; font-weight: bold;">{</span><span style="color: #000000;">stop</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">normal</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">State</span><span style="color: #000000; font-weight: bold;">}.</span>

<span style="color: #000000;">handle_cast</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">show_all</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">State</span><span style="color: #000000; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">-&gt;</span>
	<span style="color: #000000;">io</span><span style="color: #000000; font-weight: bold;">:</span><span style="color: #000000;">format</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #4e9a06;">"~p~n"</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000; font-weight: bold;">[</span><span style="color: #000000;">State</span><span style="color: #000000; font-weight: bold;">]),</span>
	<span style="color: #000000; font-weight: bold;">{</span><span style="color: #000000;">noreply</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">State</span><span style="color: #000000; font-weight: bold;">}.</span>
</pre>
</div>
<p>In our gen_server functions we can see the init function that was called with start_link, since we passed no arguments our server returns an empty list state.</p>
<p>We can also see how we handle all the message calls and casts.</p>
<p>I have to note that our functions are gen_server:call(nodeA.... because that is what we named our server during the start_link function. If other clients would be sending calls or casts they would be sending them either to that name or to the PID.</p>
<p style="margin-bottom: 0in;">Lets add the last part of our module. &nbsp;</p>
<!-- HTML generated using hilite.me -->
<div style="background: white; overflow: auto; width: auto; color: black; border: solid gray; border-width: .1em .1em .1em .8em; padding: .2em .6em;">
<pre style="margin: 0; line-height: 125%;"><span style="color: #000000;">handle_info</span><span style="color: #000000; font-weight: bold;">(_,</span> <span style="color: #000000;">State</span><span style="color: #000000; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">-&gt;</span>
	<span style="color: #000000; font-weight: bold;">{</span><span style="color: #000000;">ok</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">State</span><span style="color: #000000; font-weight: bold;">}.</span>

<span style="color: #000000;">code_change</span><span style="color: #000000; font-weight: bold;">(_</span><span style="color: #000000;">OldVsn</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">State</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000; font-weight: bold;">_</span><span style="color: #000000;">Extra</span><span style="color: #000000; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">-&gt;</span>
	<span style="color: #000000; font-weight: bold;">{</span><span style="color: #000000;">ok</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">State</span><span style="color: #000000; font-weight: bold;">}.</span>

<span style="color: #000000;">terminate</span><span style="color: #000000; font-weight: bold;">(_</span><span style="color: #000000;">Reason</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000; font-weight: bold;">_</span><span style="color: #000000;">State</span><span style="color: #000000; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">-&gt;</span>
	<span style="color: #000000;">ok</span><span style="color: #000000; font-weight: bold;">.</span></pre>
</div>
<p style="margin-bottom: 0in;">These are standard functions needed for gen_servers. We don't need to worry much about them right now, and even in more advanced projects they usually take the same arguments but if we don't include them the compiler will complain because they are expected to be defined as part of the gen_server behavior.</p>
<p style="margin-bottom: 0in;">Let's test it out.</p>
<!-- HTML generated using hilite.me -->
<div style="background: white; overflow: auto; width: auto; color: black; border: solid gray; border-width: .1em .1em .1em .8em; padding: .2em .6em;">
<pre style="margin: 0; line-height: 125%;"><span style="color: #0000cf; font-weight: bold;">1</span><span style="color: #ce5c00; font-weight: bold;">&gt;</span> <span style="color: #000000;">c</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">assoc_store</span><span style="color: #000000; font-weight: bold;">).</span>
<span style="color: #000000; font-weight: bold;">{</span><span style="color: #000000;">ok</span><span style="color: #000000; font-weight: bold;">,</span><span style="color: #000000;">assoc_store</span><span style="color: #000000; font-weight: bold;">}</span>
<span style="color: #0000cf; font-weight: bold;">2</span><span style="color: #ce5c00; font-weight: bold;">&gt;</span> <span style="color: #000000;">assoc_store</span><span style="color: #000000; font-weight: bold;">:</span><span style="color: #000000;">start_link</span><span style="color: #000000; font-weight: bold;">().</span>
<span style="color: #000000; font-weight: bold;">{</span><span style="color: #000000;">ok</span><span style="color: #000000; font-weight: bold;">,</span><span style="color: #ce5c00; font-weight: bold;">&lt;</span><span style="color: #0000cf; font-weight: bold;">0</span><span style="color: #000000; font-weight: bold;">.</span><span style="color: #0000cf; font-weight: bold;">39</span><span style="color: #000000; font-weight: bold;">.</span><span style="color: #0000cf; font-weight: bold;">0</span><span style="color: #ce5c00; font-weight: bold;">&gt;</span><span style="color: #000000; font-weight: bold;">}</span>
<span style="color: #0000cf; font-weight: bold;">3</span><span style="color: #ce5c00; font-weight: bold;">&gt;</span> <span style="color: #000000;">assoc_store</span><span style="color: #000000; font-weight: bold;">:</span><span style="color: #000000;">add_user</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">joey</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">joey</span><span style="color: #000000; font-weight: bold;">@</span><span style="color: #000000;">gmail</span><span style="color: #000000; font-weight: bold;">.</span><span style="color: #000000;">com</span><span style="color: #000000; font-weight: bold;">).</span>
<span style="color: #000000; font-weight: bold;">[{</span><span style="color: #000000;">joey</span><span style="color: #000000; font-weight: bold;">,</span><span style="color: #000000;">'joey@gmail.com'</span><span style="color: #000000; font-weight: bold;">}]</span>
<span style="color: #000000;">ok</span>
<span style="color: #0000cf; font-weight: bold;">4</span><span style="color: #ce5c00; font-weight: bold;">&gt;</span> <span style="color: #000000;">assoc_store</span><span style="color: #000000; font-weight: bold;">:</span><span style="color: #000000;">add_user</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">bob</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">bob</span><span style="color: #000000; font-weight: bold;">@</span><span style="color: #000000;">gmail</span><span style="color: #000000; font-weight: bold;">.</span><span style="color: #000000;">com</span><span style="color: #000000; font-weight: bold;">).</span>  
<span style="color: #000000; font-weight: bold;">[{</span><span style="color: #000000;">bob</span><span style="color: #000000; font-weight: bold;">,</span><span style="color: #000000;">'bob@gmail.com'</span><span style="color: #000000; font-weight: bold;">},{</span><span style="color: #000000;">joey</span><span style="color: #000000; font-weight: bold;">,</span><span style="color: #000000;">'joey@gmail.com'</span><span style="color: #000000; font-weight: bold;">}]</span>
<span style="color: #000000;">ok</span>
<span style="color: #0000cf; font-weight: bold;">5</span><span style="color: #ce5c00; font-weight: bold;">&gt;</span> <span style="color: #000000;">assoc_store</span><span style="color: #000000; font-weight: bold;">:</span><span style="color: #000000;">add_user</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">howard</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">howie</span><span style="color: #000000; font-weight: bold;">@</span><span style="color: #000000;">hushmail</span><span style="color: #000000; font-weight: bold;">.</span><span style="color: #000000;">com</span><span style="color: #000000; font-weight: bold;">).</span>
<span style="color: #000000; font-weight: bold;">[{</span><span style="color: #000000;">howard</span><span style="color: #000000; font-weight: bold;">,</span><span style="color: #000000;">'howie@hushmail.com'</span><span style="color: #000000; font-weight: bold;">},{</span><span style="color: #000000;">bob</span><span style="color: #000000; font-weight: bold;">,</span><span style="color: #000000;">'bob@gmail.com'</span><span style="color: #000000; font-weight: bold;">},{</span><span style="color: #000000;">joey</span><span style="color: #000000; font-weight: bold;">,</span><span style="color: #000000;">'joey@gmail.com'</span><span style="color: #000000; font-weight: bold;">}]</span>
<span style="color: #000000;">ok</span>
<span style="color: #0000cf; font-weight: bold;">6</span><span style="color: #ce5c00; font-weight: bold;">&gt;</span> <span style="color: #000000;">assoc_store</span><span style="color: #000000; font-weight: bold;">:</span><span style="color: #000000;">remove_user</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">bob</span><span style="color: #000000; font-weight: bold;">).</span>
<span style="color: #000000;">ok</span>
<span style="color: #0000cf; font-weight: bold;">7</span><span style="color: #ce5c00; font-weight: bold;">&gt;</span> <span style="color: #000000;">assoc_store</span><span style="color: #000000; font-weight: bold;">:</span><span style="color: #000000;">find_user</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">joey</span><span style="color: #000000; font-weight: bold;">).</span>
<span style="color: #000000;">User</span><span style="color: #000000; font-weight: bold;">:</span> <span style="color: #000000;">joey's</span> <span style="color: #000000;">email</span> <span style="color: #000000;">is</span> <span style="color: #000000;">joey</span><span style="color: #000000; font-weight: bold;">@</span><span style="color: #000000;">gmail</span><span style="color: #000000; font-weight: bold;">.</span><span style="color: #000000;">com</span><span style="color: #000000; font-weight: bold;">.</span>
<span style="color: #000000;">ok</span>       
<span style="color: #0000cf; font-weight: bold;">8</span><span style="color: #ce5c00; font-weight: bold;">&gt;</span> <span style="color: #000000;">assoc_store</span><span style="color: #000000; font-weight: bold;">:</span><span style="color: #000000;">show_all</span><span style="color: #000000; font-weight: bold;">().</span>
<span style="color: #000000; font-weight: bold;">[{</span><span style="color: #000000;">howard</span><span style="color: #000000; font-weight: bold;">,</span><span style="color: #000000;">'howie@hushmail.com'</span><span style="color: #000000; font-weight: bold;">},{</span><span style="color: #000000;">joey</span><span style="color: #000000; font-weight: bold;">,</span><span style="color: #000000;">'joey@gmail.com'</span><span style="color: #000000; font-weight: bold;">}]</span>
<span style="color: #000000;">ok</span>
</pre>
</div>
<p>Cool.</p>
<p>Next we are going to edit our code to add a simple event manager.&nbsp;</p>
<p>It is actually very simple, we modify our init to start the event manager, then add our handler.</p>
<!-- HTML generated using hilite.me -->
<div style="background: white; overflow: auto; width: auto; color: black; border: solid gray; border-width: .1em .1em .1em .8em; padding: .2em .6em;">
<pre style="margin: 0; line-height: 125%;"><span style="color: #000000;">init</span><span style="color: #000000; font-weight: bold;">([])</span> <span style="color: #ce5c00; font-weight: bold;">-&gt;</span>
	<span style="color: #000000;">gen_event</span><span style="color: #000000; font-weight: bold;">:</span><span style="color: #000000;">start</span><span style="color: #000000; font-weight: bold;">({</span><span style="color: #000000;">local</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">error_man</span><span style="color: #000000; font-weight: bold;">}),</span>
	<span style="color: #000000;">gen_event</span><span style="color: #000000; font-weight: bold;">:</span><span style="color: #000000;">add_handler</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">error_man</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">as_handler</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000; font-weight: bold;">[</span><span style="color: #000000;">log</span><span style="color: #000000; font-weight: bold;">]),</span>
	<span style="color: #000000; font-weight: bold;">{</span><span style="color: #000000;">ok</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000; font-weight: bold;">[]}.</span></pre>
</div>
<p>We are also going to modify our functions so they send the action to our event handler.</p>
<!-- HTML generated using hilite.me -->
<div style="background: white; overflow: auto; width: auto; color: black; border: solid gray; border-width: .1em .1em .1em .8em; padding: .2em .6em;">
<pre style="margin: 0; line-height: 125%;"><span style="color: #000000;">add_user</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">Name</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">Email</span><span style="color: #000000; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">-&gt;</span>
	<span style="color: #000000;">gen_server</span><span style="color: #000000; font-weight: bold;">:</span><span style="color: #000000;">call</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">nodeA</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000; font-weight: bold;">{</span><span style="color: #000000;">add_user</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">Name</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">Email</span><span style="color: #000000; font-weight: bold;">}),</span>
	<span style="color: #000000;">gen_event</span><span style="color: #000000; font-weight: bold;">:</span><span style="color: #000000;">notify</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">error_man</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000; font-weight: bold;">{</span><span style="color: #000000;">add_user</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">Name</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">Email</span><span style="color: #000000; font-weight: bold;">}).</span>

<span style="color: #000000;">remove_user</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">Name</span><span style="color: #000000; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">-&gt;</span> 
	<span style="color: #000000;">gen_server</span><span style="color: #000000; font-weight: bold;">:</span><span style="color: #000000;">call</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">nodeA</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000; font-weight: bold;">{</span><span style="color: #000000;">remove_user</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">Name</span><span style="color: #000000; font-weight: bold;">}),</span>
	<span style="color: #000000;">gen_event</span><span style="color: #000000; font-weight: bold;">:</span><span style="color: #000000;">notify</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">error_man</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000; font-weight: bold;">{</span><span style="color: #000000;">remove_user</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">Name</span><span style="color: #000000; font-weight: bold;">}).</span>
</pre>
</div>
<p>Our handler code in it's entirety is here, all we do is open a file and log additions and deletions.</p>
<!-- HTML generated using hilite.me -->
<div style="background: white; overflow: auto; width: auto; color: black; border: solid gray; border-width: .1em .1em .1em .8em; padding: .2em .6em;">
<pre style="margin: 0; line-height: 125%;"><span style="color: #000000; font-weight: bold;">-</span><span style="color: #ce5c00;">module</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">as_handler</span><span style="color: #000000; font-weight: bold;">).</span>
<span style="color: #000000; font-weight: bold;">-</span><span style="color: #ce5c00;">behaviour</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">gen_event</span><span style="color: #000000; font-weight: bold;">).</span>

<span style="color: #000000; font-weight: bold;">-</span><span style="color: #ce5c00;">export</span><span style="color: #000000; font-weight: bold;">([</span><span style="color: #000000;">init</span><span style="color: #ce5c00; font-weight: bold;">/</span><span style="color: #0000cf; font-weight: bold;">1</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">handle_event</span><span style="color: #ce5c00; font-weight: bold;">/</span><span style="color: #0000cf; font-weight: bold;">2</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">handle_call</span><span style="color: #ce5c00; font-weight: bold;">/</span><span style="color: #0000cf; font-weight: bold;">2</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">handle_info</span><span style="color: #ce5c00; font-weight: bold;">/</span><span style="color: #0000cf; font-weight: bold;">2</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">code_change</span><span style="color: #ce5c00; font-weight: bold;">/</span><span style="color: #0000cf; font-weight: bold;">3</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">terminate</span><span style="color: #ce5c00; font-weight: bold;">/</span><span style="color: #0000cf; font-weight: bold;">2</span><span style="color: #000000; font-weight: bold;">]).</span>

<span style="color: #000000;">init</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">Name</span><span style="color: #000000; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">-&gt;</span>
	<span style="color: #000000; font-weight: bold;">{</span><span style="color: #000000;">ok</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">Fd</span><span style="color: #000000; font-weight: bold;">}</span> <span style="color: #ce5c00; font-weight: bold;">=</span> <span style="color: #000000;">file</span><span style="color: #000000; font-weight: bold;">:</span><span style="color: #000000;">open</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">Name</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">write</span><span style="color: #000000; font-weight: bold;">),</span>
	<span style="color: #000000; font-weight: bold;">{</span><span style="color: #000000;">ok</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">Fd</span><span style="color: #000000; font-weight: bold;">}.</span>

<span style="color: #000000;">handle_event</span><span style="color: #000000; font-weight: bold;">({</span><span style="color: #000000;">add_user</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">Name</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">Email</span><span style="color: #000000; font-weight: bold;">},</span> <span style="color: #000000;">Fd</span><span style="color: #000000; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">-&gt;</span>
	<span style="color: #000000;">io</span><span style="color: #000000; font-weight: bold;">:</span><span style="color: #000000;">format</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">Fd</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #4e9a06;">"Added user:~s email: ~s~n"</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000; font-weight: bold;">[</span><span style="color: #000000;">Name</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">Email</span><span style="color: #000000; font-weight: bold;">]),</span>
	<span style="color: #000000; font-weight: bold;">{</span><span style="color: #000000;">ok</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">Fd</span><span style="color: #000000; font-weight: bold;">};</span>
<span style="color: #000000;">handle_event</span><span style="color: #000000; font-weight: bold;">({</span><span style="color: #000000;">remove_user</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">Name</span><span style="color: #000000; font-weight: bold;">},</span> <span style="color: #000000;">Fd</span><span style="color: #000000; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">-&gt;</span>
	<span style="color: #000000;">io</span><span style="color: #000000; font-weight: bold;">:</span><span style="color: #000000;">format</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #000000;">Fd</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #4e9a06;">"Removed user:~s~n"</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000; font-weight: bold;">[</span><span style="color: #000000;">Name</span><span style="color: #000000; font-weight: bold;">]),</span>
	<span style="color: #000000; font-weight: bold;">{</span><span style="color: #000000;">ok</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">Fd</span><span style="color: #000000; font-weight: bold;">};</span>
<span style="color: #000000;">handle_event</span><span style="color: #000000; font-weight: bold;">(_,</span> <span style="color: #000000;">Fd</span><span style="color: #000000; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">-&gt;</span>
	<span style="color: #000000; font-weight: bold;">{</span><span style="color: #000000;">ok</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">Fd</span><span style="color: #000000; font-weight: bold;">}.</span>

<span style="color: #000000;">handle_call</span><span style="color: #000000; font-weight: bold;">(_,</span> <span style="color: #000000;">Fd</span><span style="color: #000000; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">-&gt;</span>
	<span style="color: #000000; font-weight: bold;">{</span><span style="color: #000000;">ok</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">ok</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">Fd</span><span style="color: #000000; font-weight: bold;">}.</span>

<span style="color: #000000;">handle_info</span><span style="color: #000000; font-weight: bold;">(_,</span> <span style="color: #000000;">Fd</span><span style="color: #000000; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">-&gt;</span>
	<span style="color: #000000; font-weight: bold;">{</span><span style="color: #000000;">ok</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">Fd</span><span style="color: #000000; font-weight: bold;">}.</span>

<span style="color: #000000;">code_change</span><span style="color: #000000; font-weight: bold;">(_</span><span style="color: #000000;">OldVsn</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">Fd</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000; font-weight: bold;">_</span><span style="color: #000000;">Extra</span><span style="color: #000000; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">-&gt;</span>
	<span style="color: #000000; font-weight: bold;">{</span><span style="color: #000000;">ok</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000;">Fd</span><span style="color: #000000; font-weight: bold;">}.</span>

<span style="color: #000000;">terminate</span><span style="color: #000000; font-weight: bold;">(_</span><span style="color: #000000;">Reason</span><span style="color: #000000; font-weight: bold;">,</span> <span style="color: #000000; font-weight: bold;">_</span><span style="color: #000000;">State</span><span style="color: #000000; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">-&gt;</span>
	<span style="color: #000000;">ok</span><span style="color: #000000; font-weight: bold;">.</span>
</pre>
</div>
<p>If we run the tests again we can see nothing in our interface changes but we will have a .txt file with all the additions and deletions logged.</p>
<p>With OTP everything is made to fit together and perform well, no need to write the message passing code all Erlang applications use extensively. While not an advanced program this address book gave us a feel for OTP behaviors and how easy is it to write clients and servers.</p>
<p>You can find the code at:&nbsp;https://github.com/Ghostface-jr/blogs/tree/master/post3</p>
